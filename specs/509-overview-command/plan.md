# Implementation Plan: Unified Cost Overview Dashboard

**Branch**: `509-overview-command` | **Date**: 2026-02-11 | **Spec**: [spec.md](spec.md)  
**Input**: Feature specification from `/specs/509-overview-command/spec.md`

**Note**: This plan was generated by the implementation planning workflow. See `research.md`, `data-model.md`, `contracts/`, and `quickstart.md` for complete design documentation.

## Summary

The Overview Command provides a unified, interactive dashboard that combines actual costs, projected costs, and recommendations for every resource in a Pulumi stack. The implementation merges data from Pulumi state, Pulumi preview, and plugin cost APIs into a single resource-centric view with progressive loading, supporting both interactive TUI and non-interactive plain text modes. The solution leverages existing infrastructure (Bubble Tea for TUI, Cobra for CLI) and requires no new dependencies.

## Technical Context

**Language/Version**: Go 1.22+ (existing project requirement)  
**Primary Dependencies**: 
  - `github.com/spf13/cobra` (CLI framework, existing)
  - `github.com/charmbracelet/bubbletea` (TUI framework, existing)
  - `github.com/charmbracelet/bubbles/table` (Table component, existing)
  - `github.com/charmbracelet/lipgloss` (Styling, existing)
  - No new dependencies required ✅

**Storage**: None (ephemeral data, computed on-demand). Reuses existing cache layer (`internal/engine/cache`) for actual cost queries.  
**Testing**: Go testing framework + testify (existing), table-driven tests, golden file snapshots  
**Target Platform**: Linux (amd64, arm64), macOS (amd64, arm64), Windows (amd64) - cross-platform per constitution  
**Project Type**: Single (CLI tool, monorepo structure)  
**Performance Goals**: 
  - Initial UI render: <500ms (FR-002)
  - Per-resource update: <50ms TUI refresh
  - Merge 100 resources: <5ms
  - Pagination threshold: 250 resources per page

**Constraints**: 
  - Must work with TTY and non-TTY environments
  - Progressive loading (no blocking on full data fetch)
  - Partial failures acceptable (per-resource errors don't fail command)
  - API rate limits: 10 concurrent queries max (existing engine limit)

**Scale/Scope**: 
  - Small stacks: 10 resources (5-10 sec execution)
  - Medium stacks: 100 resources (30-60 sec execution)
  - Large stacks: 250 resources (60-120 sec, auto-pagination)
  - Very large stacks: 500+ resources (pagination required)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with FinFocus Core Constitution (`.specify/memory/constitution.md`):

- [x] **Plugin-First Architecture**: ✅ This is orchestration logic (CLI command), not a plugin. Reuses existing plugin system.
- [x] **Test-Driven Development**: ✅ Tests planned in quickstart.md before implementation (80% minimum coverage, 95% for critical paths)
- [x] **Cross-Platform Compatibility**: ✅ Go code compiles on Linux, macOS, Windows. No platform-specific dependencies.
- [x] **Documentation Integrity**: ✅ README.md and docs/ updates planned in Phase 9 (quickstart.md)
- [x] **Protocol Stability**: ✅ No protocol changes. Reuses existing plugin protocols.
- [x] **Implementation Completeness**: ✅ No stubs or TODOs planned. Full implementation per quickstart.md phases.
- [x] **Quality Gates**: ✅ `make lint` and `make test` required before claiming complete (quickstart.md Phase 8)
- [x] **Multi-Repo Coordination**: ✅ Not applicable. No cross-repo dependencies. Core-only feature.

**Violations Requiring Justification**: None. All principles compliant. ✅

**Post-Design Re-Check (Phase 1 Complete)**: ✅ All artifacts generated (research.md, data-model.md, contracts/, quickstart.md). Constitution compliance verified.

## Project Structure

### Documentation (this feature)

```text
specs/509-overview-command/
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0 output (technical decisions)
├── data-model.md        # Phase 1 output (data structures)
├── quickstart.md        # Phase 1 output (implementation guide)
├── contracts/           # Phase 1 output (API contracts)
│   ├── README.md
│   ├── cli-interface.md
│   ├── engine-interface.md
│   ├── tui-interface.md
│   └── output-format.md
├── checklists/          # Existing (generated by speckit.checklist)
└── tasks.md             # Phase 2 output (NOT created by this plan - see /speckit.tasks)
```

### Source Code (repository root)

**Structure Decision**: Single project (CLI tool). This feature integrates into existing codebase structure.

```text
internal/
├── cli/
│   ├── overview.go                    # NEW: Overview command (Phase 5)
│   ├── overview_test.go               # NEW: Unit tests
│   ├── overview_integration_test.go   # NEW: Integration tests (Phase 8)
│   ├── root.go                        # MODIFIED: Add overview command
│   └── [existing cost commands...]
├── engine/
│   ├── overview_types.go              # NEW: Data structures (Phase 1)
│   ├── overview_types_test.go         # NEW: Validation tests
│   ├── overview_merge.go              # NEW: Merge logic (Phase 2)
│   ├── overview_merge_test.go         # NEW: Unit tests
│   ├── overview_drift.go              # NEW: Drift calculation (Phase 3)
│   ├── overview_drift_test.go         # NEW: Edge case tests
│   ├── overview_enrich.go             # NEW: Data enrichment (Phase 4)
│   ├── overview_enrich_test.go        # NEW: Mock plugin tests
│   ├── overview_render.go             # NEW: Output rendering (Phase 7)
│   ├── overview_render_test.go        # NEW: Golden file tests
│   └── [existing engine code...]
├── tui/
│   ├── overview_model.go              # NEW: TUI model (Phase 6)
│   ├── overview_model_test.go         # NEW: State transition tests
│   ├── overview_view.go               # NEW: Rendering logic
│   ├── overview_detail.go             # NEW: Detail view
│   └── [existing TUI components...]
└── [existing internal packages...]

testdata/
└── overview/                          # NEW: Test fixtures (Phase 8)
    ├── state-no-changes.json
    ├── state-mixed-changes.json
    ├── plan-no-changes.json
    ├── plan-mixed-changes.json
    ├── schema.json                    # JSON Schema for validation
    └── golden/
        ├── table-no-changes.txt
        └── table-with-changes.txt

docs/
└── commands/
    └── overview.md                    # NEW: Command documentation (Phase 9)

README.md                              # MODIFIED: Add overview example (Phase 9)
```

**Key Directories**:
- `internal/cli/`: Command definitions and execution logic
- `internal/engine/`: Core business logic (merge, enrich, render)
- `internal/tui/`: Interactive UI components (Bubble Tea)
- `testdata/overview/`: Test fixtures and golden files
- `docs/commands/`: User-facing documentation

## Complexity Tracking

> **No complexity violations identified.** This section is empty per template guidance.

## Implementation Phases

### Phase 0: Research & Design (COMPLETED ✅)

**Objective**: Resolve all technical unknowns and establish design decisions.

**Artifacts Generated**:
- ✅ `research.md` - Technical decisions, architecture patterns, edge case handling
- ✅ `data-model.md` - Data structures, validation rules, state machines
- ✅ `contracts/cli-interface.md` - CLI command specification
- ✅ `contracts/engine-interface.md` - Core engine function signatures
- ✅ `contracts/tui-interface.md` - Interactive TUI specifications
- ✅ `contracts/output-format.md` - JSON/NDJSON/Table schemas
- ✅ `quickstart.md` - Implementation guide for developers

**Key Decisions**:
1. Resource-centric merge with URN as key
2. Progressive loading with Bubble Tea message bus
3. 10% cost drift threshold with extrapolation
4. Extend existing `tui.CostViewModel` pattern
5. Auto-pagination at 250 resources
6. No new dependencies required

---

### Phase 1: Core Data Structures (Week 1)

**Objective**: Implement foundational types and validation.

**Tasks**:
1. Create `internal/engine/overview_types.go`:
   - Define `OverviewRow`, `ResourceStatus` enum
   - Define `ActualCostData`, `ProjectedCostData`, `CostDriftData`
   - Define `OverviewRowError`, `DateRange`, `StackContext`
   - Implement `Validate()` methods for all types

2. Create `internal/engine/overview_types_test.go`:
   - Table-driven validation tests (80%+ coverage)
   - Edge case tests for each type

**Success Criteria**:
- All types compile without errors
- Validation tests pass
- `go test ./internal/engine/overview_types* -v` succeeds

**Time Estimate**: 2 days

---

### Phase 2: Merge Logic (Week 1-2)

**Objective**: Merge Pulumi state and preview into unified overview rows.

**Tasks**:
1. Create `internal/engine/overview_merge.go`:
   - Implement `MergeResourcesForOverview(ctx, state, plan)`
   - Implement `MapOperationToStatus(op string)`
   - Preserve Pulumi state file order (FR-011)

2. Create `internal/engine/overview_merge_test.go`:
   - Test empty state/plan
   - Test all operation types (create, update, delete, replace)
   - Test new resources in plan (not in state)
   - Test mixed scenarios

**Success Criteria**:
- 100 resources merge in <5ms (benchmark)
- All test cases pass
- 95%+ test coverage (critical path)

**Time Estimate**: 3 days

---

### Phase 3: Cost Drift Calculation (Week 2)

**Objective**: Detect cost prediction discrepancies.

**Tasks**:
1. Create `internal/engine/overview_drift.go`:
   - Implement `CalculateCostDrift(actualMTD, projected, dayOfMonth, daysInMonth)`
   - Handle edge cases (day 1-2, deleted resources, new resources)

2. Create `internal/engine/overview_drift_test.go`:
   - Test 10% threshold boundary
   - Test edge cases (early month, zero values)
   - Test extrapolation formula accuracy

**Success Criteria**:
- 1000 drift calculations in <10ms (benchmark)
- All edge cases handled correctly
- 95%+ test coverage

**Time Estimate**: 2 days

---

### Phase 4: Data Enrichment (Week 2-3)

**Objective**: Fetch cost data from plugins and enrich overview rows.

**Tasks**:
1. Create `internal/engine/overview_enrich.go`:
   - Implement `EnrichOverviewRow(ctx, row, plugins, dateRange)`
   - Implement `EnrichOverviewRows()` with concurrency (10 goroutines max)
   - Implement progress channel for progressive loading
   - Handle partial failures (populate row.Error)

2. Create `internal/engine/overview_enrich_test.go`:
   - Unit tests with mock plugins
   - Concurrent enrichment tests (100 resources)
   - Partial failure scenarios (50% API failures)

**Success Criteria**:
- Concurrent enrichment works correctly
- Partial failures don't crash command
- 80%+ test coverage

**Time Estimate**: 4 days

---

### Phase 5: CLI Command (Week 3)

**Objective**: Create the `finfocus overview` command.

**Tasks**:
1. Create `internal/cli/overview.go`:
   - Implement `NewOverviewCmd()` with all flags
   - Implement `executeOverview()` main logic
   - Implement pre-flight confirmation prompt
   - Implement change detection optimization (FR-008)
   - Handle TTY vs non-TTY detection

2. Create `internal/cli/overview_test.go`:
   - Flag parsing tests
   - Input validation tests
   - Error message formatting tests

3. Modify `internal/cli/root.go`:
   - Add `NewOverviewCmd()` to subcommands

**Success Criteria**:
- Command compiles and registers
- All flags work correctly
- Pre-flight prompt displays
- 80%+ test coverage

**Time Estimate**: 3 days

---

### Phase 6: Interactive TUI (Week 3-4)

**Objective**: Build the Bubble Tea interactive dashboard.

**Tasks**:
1. Create `internal/tui/overview_model.go`:
   - Implement `OverviewModel` struct
   - Implement `NewOverviewModel(ctx, skeletonRows, totalCount)`
   - Implement `Update(msg tea.Msg)` - handle all message types
   - Implement sorting (cost, name, type, delta)
   - Implement filtering (URN, type matching)
   - Implement pagination (250 resources per page)

2. Create `internal/tui/overview_view.go`:
   - Implement `View() string` - render all states
   - Implement progress banner rendering
   - Implement table rendering
   - Implement pagination footer

3. Create `internal/tui/overview_detail.go`:
   - Implement `DetailViewModel` struct
   - Implement detail view rendering (cost breakdown, recommendations)

4. Create `internal/tui/overview_model_test.go`:
   - State transition tests (loading → list → detail)
   - Keyboard input handling tests
   - Sorting logic tests
   - Filtering logic tests
   - Pagination logic tests

**Success Criteria**:
- TUI launches and responds to input
- Progressive loading works (banner updates)
- Detail view accessible via Enter key
- 80%+ test coverage

**Time Estimate**: 5 days

---

### Phase 7: Output Rendering (Week 4)

**Objective**: Implement JSON, NDJSON, and plain table output formats.

**Tasks**:
1. Create `internal/engine/overview_render.go`:
   - Implement `RenderOverviewAsJSON(rows, metadata)`
   - Implement `RenderOverviewAsNDJSON(rows)`
   - Implement `RenderOverviewAsTable(rows)` - ASCII table
   - Implement summary footer calculation
   - Implement currency formatting helpers

2. Create `internal/engine/overview_render_test.go`:
   - JSON schema validation tests
   - NDJSON line-by-line parsing tests
   - Table golden file comparison tests
   - Currency formatting edge case tests

**Success Criteria**:
- All output formats match specifications
- Golden file tests pass
- 80%+ test coverage

**Time Estimate**: 3 days

---

### Phase 8: Integration Tests (Week 5)

**Objective**: End-to-end testing with fixture data.

**Tasks**:
1. Create test fixtures in `testdata/overview/`:
   - `state-no-changes.json` (10 resources, no pending updates)
   - `state-mixed-changes.json` (50 resources, 10 updates)
   - `state-large-stack.json` (300 resources, pagination test)
   - `plan-no-changes.json` (empty steps array)
   - `plan-mixed-changes.json` (all operation types)
   - `schema.json` (JSON Schema for output validation)
   - `golden/table-no-changes.txt` (expected ASCII output)
   - `golden/table-with-changes.txt` (expected ASCII output)

2. Create `internal/cli/overview_integration_test.go`:
   - Full command execution with fixtures
   - Verify exit codes
   - Verify JSON/table output matches golden files
   - Test error scenarios (missing files, invalid dates)
   - Test optimization path (no changes detected)

**Success Criteria**:
- All integration tests pass
- Golden files match actual output
- 95%+ coverage for critical paths

**Time Estimate**: 3 days

---

### Phase 9: Documentation (Week 5)

**Objective**: Update user-facing documentation.

**Tasks**:
1. Update `README.md`:
   - Add "Unified Cost Overview" section
   - Add example usage
   - Add screenshot/animation (if applicable)

2. Create `docs/commands/overview.md`:
   - Full command reference
   - All flag descriptions
   - Usage examples (interactive, plain, JSON)
   - Troubleshooting tips

3. Run documentation validation:
   - `make lint` (markdown linting)
   - Verify godoc comments (80%+ coverage)

**Success Criteria**:
- README updated
- Full command docs created
- Markdown linting passes
- Godoc coverage ≥80%

**Time Estimate**: 2 days

---

### Phase 10: Final Validation (Week 5)

**Objective**: Ensure all quality gates pass.

**Tasks**:
1. Run full test suite:
   ```bash
   make test
   ```

2. Run linter:
   ```bash
   make lint
   ```

3. Run benchmarks:
   ```bash
   go test -bench=. -benchmem ./internal/engine/
   ```

4. Manual testing with real Pulumi stack:
   - Small stack (10 resources)
   - Medium stack (100 resources)
   - Large stack (250+ resources, test pagination)
   - Test interactive mode (all keyboard shortcuts)
   - Test plain mode (verify ASCII table)
   - Test JSON/NDJSON output

5. Cross-platform verification:
   - Build on Linux, macOS, Windows
   - Test TTY detection on each platform

**Success Criteria**:
- All tests pass
- Linter passes (no warnings)
- Benchmarks meet targets (research.md)
- Manual testing successful
- Cross-platform builds succeed

**Time Estimate**: 2 days

---

## Timeline Summary

| Phase | Duration | Cumulative |
|-------|----------|------------|
| Phase 0: Research & Design | ✅ COMPLETED | 0 days |
| Phase 1: Core Data Structures | 2 days | 2 days |
| Phase 2: Merge Logic | 3 days | 5 days |
| Phase 3: Cost Drift | 2 days | 7 days |
| Phase 4: Data Enrichment | 4 days | 11 days |
| Phase 5: CLI Command | 3 days | 14 days |
| Phase 6: Interactive TUI | 5 days | 19 days |
| Phase 7: Output Rendering | 3 days | 22 days |
| Phase 8: Integration Tests | 3 days | 25 days |
| Phase 9: Documentation | 2 days | 27 days |
| Phase 10: Final Validation | 2 days | 29 days |

**Total Estimated Time**: ~6 weeks (29 working days)

---

## Risk Analysis

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| API rate limits cause timeouts on large stacks | Medium | High | Pre-flight confirmation, backoff, retry logic, progress visibility |
| TUI performance degrades on >500 resources | Low | Medium | Pagination at 250, benchmarks, profiling |
| Cost drift false positives on day 1-2 of month | High | Low | Display warning "Insufficient data (day X)", skip drift calculation |
| Plugin authentication errors | Medium | Medium | Clear error messages, provider-specific docs links, error summary |
| Concurrent goroutines cause race conditions | Low | High | Limit to 10 concurrent, use sync.WaitGroup, run tests with -race flag |
| Golden file tests break on minor output changes | Medium | Low | Version golden files, clear diff output, easy to regenerate |

---

## Testing Strategy

### Test Coverage Targets

- **Overall**: 80% minimum (per constitution)
- **Critical Paths**: 95% minimum (merge, enrich, drift calculation)
- **UI Layer**: 80% (TUI, rendering)

### Test Types

1. **Unit Tests**: All core functions, validation logic, edge cases
2. **Integration Tests**: End-to-end command execution with fixtures
3. **Snapshot Tests**: Golden file comparison for output formats
4. **Benchmark Tests**: Performance verification (merge, drift, render)
5. **Race Tests**: Concurrent enrichment (`go test -race`)

### CI/CD Integration

All tests run in GitHub Actions on every commit:
- Linux (amd64, arm64)
- macOS (amd64, arm64)
- Windows (amd64)

---

## Rollout Plan

1. **Internal Testing** (Week 6):
   - Test on FinFocus team's internal Pulumi stacks
   - Gather feedback on UI/UX
   - Fix any critical bugs

2. **Beta Release** (Week 7):
   - Release as beta feature (opt-in via flag)
   - Announce in README and CHANGELOG
   - Monitor for issues

3. **General Availability** (Week 8):
   - Remove beta flag
   - Full documentation rollout
   - Announce in community channels

---

## Success Metrics

- **Functional**:
  - [ ] All user stories (P0-P1) from spec.md satisfied
  - [ ] All functional requirements (FR-001 to FR-011) implemented
  - [ ] All acceptance scenarios pass

- **Technical**:
  - [ ] Test coverage ≥80% (≥95% for critical paths)
  - [ ] Initial render <500ms (FR-002)
  - [ ] Linter passes (no warnings)
  - [ ] Cross-platform builds succeed
  - [ ] No TODOs or stubs in code (Constitution Principle VI)

- **Quality**:
  - [ ] All constitution principles compliant
  - [ ] Documentation up-to-date (README, docs/, godoc)
  - [ ] No security vulnerabilities (`govulncheck`)
  - [ ] Manual testing successful on real stacks

---

## References

- **Research**: [research.md](research.md) - Technical decisions and architecture
- **Data Model**: [data-model.md](data-model.md) - Data structures and validation
- **Contracts**: [contracts/](contracts/) - API specifications
- **Quickstart**: [quickstart.md](quickstart.md) - Implementation guide
- **Feature Spec**: [spec.md](spec.md) - Original requirements
- **Constitution**: [.specify/memory/constitution.md](../../.specify/memory/constitution.md) - Core principles

---

## Next Steps

1. Generate tasks.md with `/speckit.tasks` command
2. Begin implementation with Phase 1 (Core Data Structures)
3. Follow quickstart.md for step-by-step guidance
4. Update this plan if significant changes arise during implementation

---

**Plan Completed**: 2026-02-11  
**Ready for Implementation**: ✅ Yes  
**Next Command**: `finfocus speckit.tasks` (to generate tasks.md)
